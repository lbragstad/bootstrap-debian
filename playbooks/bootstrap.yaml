- name: bootstrap all nodes
  gather_facts: False
  hosts: all
  vars:
    - username: "{{ lookup('pipe', 'whoami') }}"
  tasks:
    - name: set message of the day
      template:
        src=templates/message-of-the-day
        dest=/etc/motd

    - name: install global inputrc
      template:
        src=templates/inputrc
        dest=/etc/inputrc

    - name: install unattended upgrades
      apt:
        pkg=unattended-upgrades
        state=present
        update_cache=yes

    - name: configure auto upgrades
      template:
        src=templates/auto-upgrades
        dest=/etc/apt/apt.conf.d/20auto-upgrades
        mode=0644

    - name: configure unattended upgrades
      template:
        src=templates/unattended-upgrades
        dest=/etc/apt/apt.conf.d/50unattended-upgrades

    - name: create an account for yourself
      user:
        name={{ username }}
        groups=sudo
        shell=/bin/bash

    - name: give passwordless sudo to yourself
      lineinfile: dest=/etc/sudoers state=present regexp='^%{{ username }} ALL\=' line='%{{ username }} ALL=(ALL) NOPASSWD:ALL' validate='visudo -cf %s'

    - name: install authorized ssh key
      authorized_key:
        user={{ username }}
        key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: install basic tools
      apt:
        pkg={{ item }}
        state=present
      with_items:
        - git
        - vim
        - tmux

- name: customize personal account
  gather_facts: False
  hosts: all
  user: "{{ lookup('pipe', 'whoami') }}"
  sudo: False
  tasks:
    - name: clone dotfiles
      git:
        repo=https://github.com/lbragstad/dotfiles.git
        dest=~/dotfiles
        force=yes

    - name: symlink dotfiles
      command: sh ~/dotfiles/symlink.sh

    - name: install pyenv
      git:
        repo=https://github.com/yyuu/pyenv.git
        dest=~/.pyenv

    - name: export pyenv root path
      shell: echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc

    - name: export pyenv path
      shell: echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc

    - name: install pyenv-virtuaenv
      git:
        repo=https://github.com/yyuu/pyenv-virtualenv.git
        dest=~/.pyenv/plugins/pyenv-virtualenv

    - name: export pyenv-virtualenv activation
      shell: echo 'eval "$(pyenv init -)"' >> ~/.bashrc

    - name: export pyenv-virtualenv activation
      shell: echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
